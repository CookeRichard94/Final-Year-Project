<!DOCTYPE html>
<html lang="en">
<head>
    <title>{% block title %}{% endblock %}</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <meta charset="UTF-8">
</head>
<body>

    {% if notifications %}
        <div id="notifications">
                {% for message in notifications %}
                    <div class="error-message">
                        {{ message }}
                    </div>
                {% endfor %}
        </div>
    {% endif %}

    <div id="cart">
            <h1>cart</h1>
            <ul id="cart">Cart empty</ul>
    </div>

    <div id="header">
            {% if request.user.username is not none and request.user.username != '' %}
                <h1> Hello {{ request.user.username }}</h1>

            {% elif request.user.username is none or request.user.username == '' %}
                <h4>You are not logged in</h4>
                <h5>You must be logged in to add to cart!</h5>
            {% endif %}
    </div>

    {% block content %}{% endblock %}

    <div id="footer">
            {% if request.user.username is none or request.user.username == '' %}
                <a href="{% url 'login_view' %}">Login</a>
                <a href="{% url 'register' %}">Register</a>
            {% endif %}
            {% if request.user.username is not none and request.user.username != '' %}
                <a href="#" onclick="document.getElementById('logout').submit()">Logout</a>
                <form id="logout" action="{% url 'logout' %}" method="post">{% csrf_token %}</form>
                <a href="{% url 'view_user' %}">View your profile details</a>
            {% endif %}
    </div>
    <div id="script">
            <script>
                function addToCart(item) {
                    $.ajax({
                        url: '{% url "cart" %}',
                        type: 'POST',
                        data: {
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                            'product_id': item,
                            'action': "add_to_cart"
                        },
                        success: function (msg) {
                            updateCart();
                        }
                    });
                }
                function removeFromCart(item) {
                    $.ajax({
                        url: '{% url "cart" %}',
                        type: 'POST',
                        data: {
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                            'product_id': item,
                            'action': "remove_from_cart"
                        },
                        success: function (msg){
                            updateCart();
                        }
                    });
                }
                function updateCart() {
                    $.ajax({
                        url: '{% url "cart" %}',
                        type: 'GET',
                        success: function (data) {
                            console.log(data);
                            listElement = document.getElementById("cart");
                            listElement.innerHTML = ""
                            var total = 0;
                            data.forEach(function (product) {
                                {#var stock = document.createElement("stock");#}
                                {#stock.innerText = product.fields.quantity + " left in stock";#}
                                {#listElement.appendChild(stock);#}
                                var li = document.createElement("li");
                                li.innerText = product.fields.name +" €"+ product.fields.price;
                                listElement.appendChild(li);
                                total += parseFloat(product.fields.price);
                                {#var ct = document.createElement("cartTotal")#}
                                {#ct.innerText = total;#}
                                {#listElement.appendChild(ct);#}
                                var btn = document.createElement("button")
                                btn.innerHTML = 'remove';
                                btn.addEventListener("click", function(){removeFromCart(product.pk)})
                                listElement.appendChild(btn);
                            })
                            listElement.append("Total cart cost: €"+ (total).toFixed(2));
                        }
                    });
                }
                updateCart();
            </script>
    </div>
</body>
</html>